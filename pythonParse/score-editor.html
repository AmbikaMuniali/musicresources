<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Éditeur de Partitions Tonic Solfa</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .note {
            cursor: pointer;
            min-width: 40px;
            text-align: center;
        }
        .note-content {
            border: 1px solid #e2e8f0;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: #f8fafc;
        }
        .measure {
            border-left: 2px solid black;
            padding-left: 5px;
            display: flex;
            gap: 5px;
        }
        .system-brace-start {
            font-size: 4rem;
            line-height: 1;
            align-self: stretch;
            display: flex;
            align-items: center;
        }
        .voice-name {
            font-weight: bold;
            width: 80px;
            text-align: right;
            padding-right: 10px;
        }
        .lyrics-input {
            width: 100%;
            border: 1px solid #ccc;
            padding: 2px;
            font-family: monospace;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 md:p-8">

    <div id="app" class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <!-- Entête -->
        <header class="mb-6 border-b pb-4">
            <div class="grid grid-cols-3 items-center text-center">
                <div class="text-left">
                    <input type="text" v-model="score.meta.scoreNumber" class="text-lg font-bold w-24 p-1 border rounded">
                </div>
                <h1 class="text-3xl font-bold">
                    <input type="text" v-model="score.meta.title" class="w-full text-center p-1 border rounded">
                </h1>
                <div class="text-right font-bold">
                    Gamme: <input type="text" v-model="score.meta.key" class="w-20 p-1 border rounded">
                </div>
            </div>
            <div class="grid grid-cols-3 items-center text-center mt-2">
                <div class="text-left">
                    <input type="text" v-model="score.meta.authors" class="w-full p-1 border rounded">
                </div>
                <div class="italic">
                    <input type="text" v-model="score.meta.subtitle" class="w-full text-center p-1 border rounded">
                </div>
                <div class="text-right">
                    <input type="text" v-model="score.meta.referenceBook" class="w-full text-right p-1 border rounded">
                </div>
            </div>
            <div class="flex items-end mt-4">
                <div class="mr-6">
                    <label for="time-signature" class="font-bold block">Mesure:</label>
                    <select id="time-signature" v-model="score.meta.timeSignature" class="p-1 border rounded">
                        <option>2/4</option>
                        <option>3/4</option>
                        <option>4/4</option>
                        <option>6/8</option>
                    </select>
                    <div class="text-sm">
                        Tempo: <input type="number" v-model.number="score.meta.tempo" class="w-16 p-1 border rounded"> bpm
                    </div>
                </div>
                <div>
                     <label for="performance-directions" class="font-bold block">Indications:</label>
                    <input type="text" v-model="score.meta.performanceDirections" id="performance-directions" class="p-1 border rounded w-64">
                </div>
            </div>
        </header>

        <!-- Partition -->
        <main>
            <div class="flex items-center mb-4">
                <h2 class="text-2xl font-semibold mr-4">Partition</h2>
                 <button @click="addVoice" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2 text-sm">
                    + Ajouter Voix
                </button>
                <button @click="exportToJson" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">
                    Exporter en JSON
                </button>
            </div>

            <!-- Rendu de la partition -->
            <div class="flex">
                 <div class="system-brace-start">{</div>
                 <div class="w-full">
                    <div v-for="(voice, voiceIndex) in score.voices" :key="voice.id" class="flex items-center mb-2">
                        <div class="voice-name">
                            <input type="text" v-model="voice.name" class="w-full text-right p-1 border rounded">
                        </div>
                        <div class="flex items-center">
                            <div v-for="(measure, measureIndex) in voice.measures" :key="measureIndex" class="measure flex-nowrap">
                                <div v-for="(beat, beatIndex) in measure.beats" :key="beatIndex" class="flex items-center gap-1">
                                    <!-- Logique d'affichage des notes -->
                                    <div v-for="(note, noteIndex) in beat.notes" :key="noteIndex" class="note" @click="editNote(voiceIndex, measureIndex, beatIndex, noteIndex)">
                                        <div v-if="editing.voice === voiceIndex && editing.measure === measureIndex && editing.beat === beatIndex && editing.note === noteIndex">
                                            <select v-model="note.pitch" class="p-1 border rounded text-sm">
                                                <option v-for="p in pitches" :value="p">{{ p }}</option>
                                            </select>
                                            <select v-model="note.octave" class="p-1 border rounded text-sm">
                                                 <option v-for="o in octaves" :value="o">{{ o }}</option>
                                            </select>
                                        </div>
                                        <div v-else class="note-content">
                                            <span>{{ note.pitch }}</span>
                                            <sup v-if="note.octave > voice.defaultOctave">{{ '|'.repeat(note.octave - voice.defaultOctave) }}</sup>
                                            <sub v-if="note.octave < voice.defaultOctave">{{ '|'.repeat(voice.defaultOctave - note.octave) }}</sub>
                                        </div>
                                    </div>
                                    <span v-if="beatIndex < measure.beats.length - 1" class="font-bold text-gray-400">:</span>
                                </div>
                                <button @click="deleteMeasure(voiceIndex, measureIndex)" class="text-red-500 hover:text-red-700 ml-2 text-xs">X</button>
                            </div>
                             <button @click="addMeasure(voiceIndex)" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-2 rounded ml-2 text-xs">+</button>
                        </div>
                         <button @click="removeVoice(voiceIndex)" class="text-red-500 hover:text-red-700 ml-2 font-bold">Supprimer Voix</button>
                    </div>
                </div>
                 <div class="system-brace-start">}</div>
            </div>
             <button @click="addMeasureToAll" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                Ajouter une mesure à toutes les voix
            </button>
        </main>

        <!-- Paroles -->
        <section class="mt-8">
            <h3 class="text-xl font-semibold mb-2">Paroles</h3>
            <div>
                <label class="font-bold">Couplet 1 (aligné avec les notes):</label>
                <div class="flex mt-2">
                     <div class="voice-name">&nbsp;</div> <!-- Spacer -->
                     <div class="flex">
                        <div v-for="(measure, measureIndex) in score.voices[0]?.measures" :key="measureIndex" class="measure">
                             <div v-for="(beat, beatIndex) in measure.beats" :key="beatIndex" class="flex gap-1">
                                <div v-for="(note, noteIndex) in beat.notes" :key="noteIndex" class="note">
                                     <input type="text" v-model="score.lyrics[0].measures[measureIndex].beats[beatIndex].notes[noteIndex]" class="lyrics-input text-center">
                                </div>
                             </div>
                        </div>
                     </div>
                </div>
            </div>
            <div class="mt-4">
                <label for="other-verses" class="font-bold">Autres couplets:</label>
                <textarea id="other-verses" v-model="score.lyrics[1].text" rows="4" class="w-full p-2 border rounded mt-1"></textarea>
            </div>
        </section>

    </div>

    <script>
        const { createApp, ref, reactive, watch } = Vue;

        createApp({
            setup() {
                // --- Données Réactives ---
                const score = reactive({
                    meta: {
                        scoreNumber: 'No. 1',
                        title: 'Titre de la Partition',
                        key: 'Do Majeur',
                        authors: 'Auteur(s)',
                        subtitle: 'Sous-titre',
                        referenceBook: 'Livre de référence',
                        timeSignature: '4/4',
                        tempo: 120,
                        performanceDirections: 'Moderato'
                    },
                    voices: [
                        { id: 1, name: 'Soprano', defaultOctave: 4, measures: [] },
                        { id: 2, name: 'Alto', defaultOctave: 4, measures: [] },
                        { id: 3, name: 'Tenor', defaultOctave: 3, measures: [] },
                        { id: 4, name: 'Basse', defaultOctave: 3, measures: [] }
                    ],
                    lyrics: [
                        { verse: 1, measures: [] },
                        { verse: 'other', text: '' }
                    ]
                });

                const pitches = ['d', 'de', 'r', 're', 'm', 'f', 'fe', 's', 'se', 'l', 'ta', 't', ' ', '-'];
                const octaves = [-3, -2, -1, 0, 1, 2, 3].map(o => 4 + o); // Centré autour de l'octave 4

                const editing = reactive({
                    voice: null,
                    measure: null,
                    beat: null,
                    note: null
                });
                
                // --- Fonctions ---

                const createEmptyNote = (octave) => ({ pitch: 's', duration: 0.25, octave: octave });
                const createEmptyBeat = (octave) => ({ notes: [createEmptyNote(octave)] });
                const createEmptyMeasure = (octave) => ({
                    beats: Array.from({ length: 4 }, () => createEmptyBeat(octave))
                });
                const createEmptyLyricsMeasure = () => ({
                    beats: Array.from({ length: 4 }, () => ({ notes: [''] }))
                });

                // Initialiser la partition avec une mesure
                const initializeScore = () => {
                    score.voices.forEach(voice => {
                        voice.measures.push(createEmptyMeasure(voice.defaultOctave));
                    });
                    score.lyrics[0].measures.push(createEmptyLyricsMeasure());
                };
                
                initializeScore();

                // Synchroniser la structure des paroles avec la première voix
                watch(() => score.voices[0]?.measures, (newMeasures) => {
                    if (!newMeasures) return;
                    const lyricsMeasures = score.lyrics[0].measures;
                    
                    // Ajuster le nombre de mesures
                    while (lyricsMeasures.length < newMeasures.length) {
                        lyricsMeasures.push(createEmptyLyricsMeasure());
                    }
                    while (lyricsMeasures.length > newMeasures.length) {
                        lyricsMeasures.pop();
                    }

                    // Synchroniser les temps et les notes dans chaque mesure
                    newMeasures.forEach((measure, mIdx) => {
                        const lyricsMeasure = lyricsMeasures[mIdx];
                        while (lyricsMeasure.beats.length < measure.beats.length) {
                            lyricsMeasure.beats.push({ notes: [''] });
                        }
                         while (lyricsMeasure.beats.length > measure.beats.length) {
                            lyricsMeasure.beats.pop();
                        }
                        
                        measure.beats.forEach((beat, bIdx) => {
                            const lyricsBeat = lyricsMeasure.beats[bIdx];
                            while(lyricsBeat.notes.length < beat.notes.length) {
                                lyricsBeat.notes.push('');
                            }
                            while(lyricsBeat.notes.length > beat.notes.length) {
                                lyricsBeat.notes.pop();
                            }
                        });
                    });
                }, { deep: true });


                const addVoice = () => {
                    const newId = score.voices.length ? Math.max(...score.voices.map(v => v.id)) + 1 : 1;
                    const newVoice = {
                        id: newId,
                        name: `Voix ${newId}`,
                        defaultOctave: 3,
                        measures: []
                    };
                    // Ajouter le même nombre de mesures que les autres voix
                    const measureCount = score.voices[0]?.measures.length || 1;
                    for (let i = 0; i < measureCount; i++) {
                        newVoice.measures.push(createEmptyMeasure(newVoice.defaultOctave));
                    }
                    score.voices.push(newVoice);
                };

                const removeVoice = (voiceIndex) => {
                    if (score.voices.length > 1) {
                        score.voices.splice(voiceIndex, 1);
                    } else {
                        alert("Il doit y avoir au moins une voix.");
                    }
                };

                const addMeasure = (voiceIndex) => {
                    const voice = score.voices[voiceIndex];
                    voice.measures.push(createEmptyMeasure(voice.defaultOctave));
                };

                const addMeasureToAll = () => {
                    score.voices.forEach(voice => {
                        voice.measures.push(createEmptyMeasure(voice.defaultOctave));
                    });
                };

                const deleteMeasure = (voiceIndex, measureIndex) => {
                     if (score.voices[voiceIndex].measures.length > 1) {
                        score.voices[voiceIndex].measures.splice(measureIndex, 1);
                    } else {
                        alert("Il doit y avoir au moins une mesure.");
                    }
                };

                const editNote = (voiceIndex, measureIndex, beatIndex, noteIndex) => {
                    if (editing.voice === voiceIndex && editing.measure === measureIndex && editing.beat === beatIndex && editing.note === noteIndex) {
                        // Clic sur la même note, on quitte le mode édition
                        Object.assign(editing, { voice: null, measure: null, beat: null, note: null });
                    } else {
                        Object.assign(editing, { voice: voiceIndex, measure: measureIndex, beat: beatIndex, note: noteIndex });
                    }
                };

                const exportToJson = () => {
                    console.log(JSON.stringify(score, null, 2));
                    alert("La structure de la partition a été affichée dans la console du navigateur (accessible avec F12).");
                };

                return {
                    score,
                    pitches,
                    octaves,
                    editing,
                    addVoice,
                    removeVoice,
                    addMeasure,
                    addMeasureToAll,
                    deleteMeasure,
                    editNote,
                    exportToJson
                };
            }
        }).mount('#app');
    </script>

</body>
</html>
